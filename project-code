#define CUSTOM_SETTINGS
#define INCLUDE_GPS_SHIELD
#define INCLUDE_SMS_SHIELD
#define INCLUDE_INTERNET_SHIELD
#define INCLUDE_CAMERA_SHIELD

#include <OneSheeld.h>

float longitude = GPS.getLongitude();
float latitude = GPS.getLatitude();

HttpRequest immobRequest("https://api.thingspeak.com/channels/228392/fields/3/last.json"); //For checking the immobilization boolean (0,1)
oneSheeld.getResponse.setOnJsonResponse(&immobRequestSuccess);
oneSheeld.getResponse[0][“field3”].query( );
HttpRequest request("https://api.thingspeak.com/update"); //This and the following 3 lines are for writing the longitude and latitude to thingspeak channel
const char *myWriteAPIKey = "KY6FGVBF9MNSM8B0";
char charSensor[11];

boolean moving = false; //Not sure if we care about whether or not the vehicle is moving???
boolean locked = true; //Vehicle starts off locked as that is the state a vehicle would most often be in
boolean stolen = false; //Starts off not stolen (obviously)
//There is a boolean held on the thingspeak channel that controls the immobilization remotely (simulated remote shutdown)
boolean tagSet = false;
int switchState = 0;

int ledPin = 13;
int count = 0;
int immob = 0;

void setup() {
  OneSheeld.begin();
  request.addParameter("api_key",myWriteAPIKey);
  pinMode(ledPin, OUTPUT);
}

//when locked LED is lit


void loop() {



if (stolen)
{
  if (Internet.performGet(immobRequest))
  {
      if(switchState) //This will unlock the immobilizer and the vehicle and perform an update of the location of the vehicle
      {
        locked = false;
        request.addParameter("field3",0);
        Internet.performPost(request);
        request.deleteParameters(); //Required so as not to update the immobilized value while performing tracking
        request.addParameter("api_key",myWriteAPIKey); //Reapply the api_key to the HttpRequest to be able to write the coordinates while tracking
      }
  }
  else
  {
    if(Internet.performGet(immobRequest)) //Checks the value of the immobilizer boolean (0,1) on the thingspeak and simulates the shutdown of the vehicle
    {
      //Simulated shutdown of vehicle and be unable to restart it without the assigned "key" (NFC tag)
    }
    trackVehicle();
    delay(20000);
  }
  
  
}

else if (locked)
{
  if (!GPS.isInRange(latitude, longitude, 20))
  {
    moving = true;
    carStolen();
  }
  else
  {
    if(switchState)
    {
      locked = false;
    }
  }
}
else
{
  if (!GPS.isInRange(latitude, longitude, 20))
  {
    moving = true;
    trackVehicle();
    delay(20000);
  }
  else
  {
    count++;
    if (count == 3)
    {
      locked = true;
      count = 0;
    }
  }
}

} //END OF loop()

void carStolen()
{
Camera.frontCapture();
SMS.send("0861231234","Your car has been stolen. The security company has been informed. You can track your car on our website //hhtp:www"); //Notify car owner
SMS.send("0867897890","Car belonging to XXX has been stolen. It is a blah blah car."); // Notify emergency line
stolen = true;
} //END OF carStolen()

void trackVehicle()
{
  longitude = GPS.getLongitude();
  latitude = GPS.getLatitude();
  dtostrf(longitude, 10, 6, charSensor);
  request.addParameter("field1", charSensor);
  dtostrf(latitude, 10, 6, charSensor);
  request.addParameter("field2", charSensor);
  Internet.performPost(request);
} //END OF trackVehicle()

void immobRequestSuccess(JsonKeyChain chain , char value[1] )
{
  sscanf(value, "%d", &immob);
}
